<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PhishSentry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-6 min-h-screen font-sans">

  <div class="max-w-6xl mx-auto space-y-12">

    <!-- Header -->
    <div class="text-center">
      <h1 class="text-4xl font-bold text-blue-800 mb-2">üõ°Ô∏è PhishSentry</h1>
      <p class="text-gray-600 text-lg">Combat phishing in real-time ‚Äî Scan or Report and visualize threats</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">

      <!-- Phishing Report Form -->
      <div class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">üì® Report a Phishing Email</h2>
        <form action="/submit/" method="post" class="space-y-4">
          <input name="sender" class="w-full border border-gray-300 p-2 rounded" placeholder="Sender Email" required>
          <input name="subject" class="w-full border border-gray-300 p-2 rounded" placeholder="Email Subject" required>
          <textarea name="content" class="w-full border border-gray-300 p-2 h-40 rounded" placeholder="Email Content" required></textarea>
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full" type="submit">Submit Report</button>
        </form>
      </div>

      <!-- URL Scan Form -->
      <div class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">üîç Real-Time URL Scanner</h2>
        <form id="phishingForm" method="POST" action="/scan" onsubmit="handleScan(event)" class="space-y-4">
          <input type="text" name="url" id="url" class="w-full border border-gray-300 p-2 rounded" placeholder="Enter URL to Scan" required>
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full">Scan Now</button>
        </form>
        <div id="result" class="mt-4 text-center text-lg font-medium text-gray-800"></div>
      </div>

    </div>

    <!-- Threats Chart -->
    <div class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-semibold mb-6 text-gray-800 text-center">üìä Real-Time Phishing Threats Dashboard</h2>
      <canvas id="phishingChart" class="w-full h-64"></canvas>
    </div>

  </div>

  <!-- Chart and JS Logic -->
  <script>
    const ctx = document.getElementById('phishingChart').getContext('2d');
    const phishingChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [], // Time labels
        datasets: [{
          label: 'Detected Phishing Attempts',
          data: [],
          backgroundColor: 'rgba(220, 38, 38, 0.2)',
          borderColor: 'rgba(220, 38, 38, 1)',
          borderWidth: 2,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        scales: {
          x: { title: { display: true, text: 'Time' } },
          y: { title: { display: true, text: 'Threat Count' }, beginAtZero: true }
        }
      }
    });

    // Fetch live chart data every 5 seconds
    async function fetchPhishingData() {
      try {
        const response = await fetch('/api/threat_stats');
        const data = await response.json();

        phishingChart.data.labels = data.timestamps;
        phishingChart.data.datasets[0].data = data.counts;
        phishingChart.update();
      } catch (error) {
        console.error('Failed to fetch threat stats:', error);
      }
    }

    setInterval(fetchPhishingData, 5000); // Auto refresh every 5 seconds
    fetchPhishingData(); // Initial fetch

    // Scan handler
    async function handleScan(event) {
      event.preventDefault();
      const url = document.getElementById('url').value;
      const resultDiv = document.getElementById('result');
      resultDiv.textContent = 'Scanning...';

      try {
        const response = await fetch('/scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const result = await response.json();
        resultDiv.textContent = result.is_phishing ? "üö® Phishing detected!" : "‚úÖ Safe link.";
      } catch (err) {
        resultDiv.textContent = '‚ùå Scan failed.';
        console.error(err);
      }
    }
  </script>

</body>
</html>
